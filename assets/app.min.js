//# sourceMappingURL=app.min.js.map

(function () {

    angular.module('meanApp', ['ngRoute']);

    function config ($routeProvider, $locationProvider) {
      $routeProvider
        .when('/', {
          templateUrl: '../app_client/views/home/home.view.html',
          controller: 'homeCtrl',
          controllerAs: 'vm'
        })
        .when('/register', {
          templateUrl: '../app_client/auth/register/register.view.html',
          controller: 'registerCtrl',
          controllerAs: 'vm'
        })
        .when('/login', {
          templateUrl: '../app_client/auth/login/login.view.html',
          controller: 'loginCtrl',
          controllerAs: 'vm'
        })
        .when('/profile', {
          templateUrl: '../app_client/profile/profile.view.html',
          controller: 'profileCtrl',
          controllerAs: 'vm'
        })
        .when('/logout', {
          template: '',
          controller: 'logoutCtrl',
          controllerAs: 'vm'
        })
        .otherwise({redirectTo: '/'});

      // use the HTML5 History API
      $locationProvider.html5Mode(true);
    }

    function run($rootScope, $location, authentication) {
      $rootScope.$on('$routeChangeStart', function(event, nextRoute, currentRoute) {
        if ($location.path() === '/profile' && !authentication.isLoggedIn()) {
          $location.path('/');
        }
      });
    }

    angular
      .module('meanApp')
      .config(['$routeProvider', '$locationProvider', config])
      .run(['$rootScope', '$location', 'authentication', run]);

  })();
  (function() {

    angular
      .module('meanApp')
      .controller('profileCtrl', profileCtrl);

    profileCtrl.$inject = ['$location', 'meanData'];
    function profileCtrl($location, meanData) {
      var vm = this;

      vm.user = {};

      meanData.getProfile()
        .success(function(data) {
          vm.user = data;
        })
        .error(function (e) {
          console.log(e);
        });
    }

  })();
  (function() {

    angular
      .module('meanApp')
      .controller('homeCtrl', homeCtrl);

      function homeCtrl () {
        console.log('Home controller is running');
      }

  })();
  (function () {

    angular
    .module('meanApp')
    .controller('loginCtrl', loginCtrl);

    loginCtrl.$inject = ['$location', 'authentication'];
    function loginCtrl($location, authentication) {
      var vm = this;

      vm.credentials = {
        email : "",
        password : ""
      };

      vm.onSubmit = function () {
        authentication
          .login(vm.credentials)
          .error(function(err){
            alert(err.error? err.error : err);
          })
          .then(function(){
            $location.path('profile');
          });
      };

    }

  })();
  (function () {

    angular
    .module('meanApp')
    .controller('logoutCtrl', logoutCtrl);

    logoutCtrl.$inject = ['$location', 'authentication'];
    function logoutCtrl($location, authentication) {
      var vm = this;
      authentication
        .logout()
        .error(function(err){
          alert(err.error? err.error : err);
        })
        .then(function(){
          $location.path('');
        });
    }

  })();
  (function () {

    angular
      .module('meanApp')
      .controller('registerCtrl', registerCtrl);

    registerCtrl.$inject = ['$location', 'authentication'];
    function registerCtrl($location, authentication) {
      var vm = this;

      vm.credentials = {
        name : "",
        email : "",
        password : ""
      };

      vm.onSubmit = function () {
        console.log('Submitting registration');
        authentication
          .register(vm.credentials)
          .error(function(err){
            alert(err.error? err.error : err);
          })
          .then(function(){
            $location.path('profile');
          });
      };

    }

  })();
  (function () {

    angular
      .module('meanApp')
      .service('authentication', authentication);

    authentication.$inject = ['$http', '$window'];
    function authentication ($http, $window) {

      var saveToken = function (token) {
        $window.localStorage['mean-token'] = token;
      };

      var getToken = function () {
        return $window.localStorage['mean-token'];
      };

      var isLoggedIn = function() {
        var token = getToken();
        var payload;

        if(token){
          payload = token.split('.')[1];
          return !!payload;
        } else {
          return false;
        }
      };

      var currentUser = function() {
        if(isLoggedIn()){
          var token = getToken();
          var payload = token.split('.')[1];
          payload = JSON.parse(payload);
          return {
            email : payload.email,
            name : payload.name
          };
        }
      };

      register = function(user) {
        return $http.post('/api/register', user).success(function(data){
          saveToken(data.token);
        });
      };

      login = function(user) {
        return $http.post('/api/login', user).success(function(data) {
          saveToken(data.token);
        });
      };

      logout = function() {
        if( isLoggedIn() ) {
          return $http.get('/api/logout', {
            headers: {
              Authorization: 'Bearer '+ getToken()
            }
          }).success(function () {
            $window.localStorage.removeItem('mean-token');
          });
        } else {
          return false;
        }
      };

      return {
        currentUser : currentUser,
        saveToken : saveToken,
        getToken : getToken,
        isLoggedIn : isLoggedIn,
        register : register,
        login : login,
        logout : logout
      };
    }


  })();
  (function() {

    angular
      .module('meanApp')
      .service('meanData', meanData);

    meanData.$inject = ['$http', 'authentication'];
    function meanData ($http, authentication) {

      var getProfile = function () {
        return $http.get('/api/profile', {
          headers: {
            Authorization: 'Bearer '+ authentication.getToken()
          }
        });
      };

      return {
        getProfile : getProfile
      };
    }

  })();
  (function () {

    angular.module('meanApp')
      .controller('navigationCtrl', navigationCtrl);

    navigationCtrl.$inject = ['$location','authentication', 'meanData'];
    function navigationCtrl($location, authentication, meanData) {
      var vm = this;

      vm.isLoggedIn = authentication.isLoggedIn();

      //vm.currentUser = authentication.currentUser();
      vm.currentUser = meanData.getProfile();
      meanData.getProfile()
      .success(function(data) {
        vm.currentUser = data;
      })
      .error(function (e) {
        console.log(e);
      });

    }

  })();
  (function () {

    angular.module('meanApp').directive('navigation', navigation);

    function navigation () {
      return {
        restrict: 'EA',
        templateUrl: '../app_client/common/directives/navigation/navigation.template.html',
        controller: 'navigationCtrl as navvm'
      };
    }

  })();
